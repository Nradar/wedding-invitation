# 数据库和云函数调用优化说明

## 优化概述

本次优化主要针对数据库和云函数调用频繁的问题，通过引入缓存机制和智能更新策略，显著减少了不必要的网络请求和数据库查询。

## 主要优化内容

### 1. 全局缓存管理器

- **位置**: `miniprogram/app.js`
- **功能**:
  - 提供全局缓存存储和检索功能
  - 支持缓存过期时间控制（默认 5 分钟）
  - 统一管理所有页面的缓存数据

### 2. 首页优化 (`miniprogram/pages/index/index.js`)

- **缓存机制**: 使用全局缓存存储祝福语和管理员列表
- **更新频率**: 从 60 秒改为 5 分钟更新一次
- **智能更新**: 只在缓存过期时才重新获取数据
- **错误处理**: 网络请求失败时自动使用缓存数据

### 3. 时间线页面优化 (`miniprogram/pages/timeline/index.js`)

- **缓存机制**: 使用全局缓存存储事件数据
- **智能加载**: 页面显示时检查缓存，避免重复请求
- **错误处理**: 网络请求失败时使用缓存数据

### 4. 云函数优化

#### Greetings 云函数 (`cloudfunctions/greetings/index.js`)

- **查询优化**: 只获取有祝福语的记录，按时间倒序排列
- **分批处理**: 大数据量时智能分批获取
- **错误处理**: 添加完整的错误处理机制

#### Managers 云函数 (`cloudfunctions/managers/index.js`)

- **字段优化**: 只获取需要的字段（openid）
- **查询效率**: 减少数据传输量

## 性能提升

### 减少的调用次数

- **首页**: 从每 60 秒调用改为每 5 分钟调用，减少 83%的调用频率
- **时间线页面**: 避免重复加载，只在必要时更新数据
- **全局缓存**: 多个页面共享缓存，避免重复请求

### 缓存策略

- **缓存时间**: 5 分钟（可配置）
- **缓存范围**: 祝福语、管理员列表、事件数据
- **缓存失效**: 自动过期或手动清除

## 使用说明

### 全局缓存 API

```javascript
const APP = getApp();

// 获取缓存数据
const cachedData = APP.getCache("key");

// 设置缓存数据
APP.setCache("key", data);

// 清除所有缓存
APP.clearCache();
```

### 页面缓存使用

```javascript
// 检查缓存
const cachedData = APP.getCache("greetings");
if (cachedData) {
  // 使用缓存数据
  this.setData({ greetings: cachedData });
  return;
}

// 获取新数据并缓存
const result = await wx.cloud.callFunction({ name: "greetings" });
APP.setCache("greetings", result.result.greetings);
```

## 注意事项

1. **缓存一致性**: 当数据更新时，需要手动清除相关缓存
2. **内存使用**: 缓存数据会占用一定内存，但会自动过期
3. **网络状态**: 网络请求失败时会自动使用缓存数据
4. **用户体验**: 缓存机制提升了页面加载速度和响应性

## 后续优化建议

1. **增量更新**: 实现增量数据更新，只获取变化的数据
2. **预加载**: 在用户可能访问的页面预加载数据
3. **压缩传输**: 对大数据量进行压缩传输
4. **监控统计**: 添加调用频率和性能监控
